Это очень плохой код. Просто отвратительный. Ужасный. Так нельзя писать.
Но мне нужно было относительно быстро получить работоспособное решение.
Моё решение работоспособное, хотя и ОЧЕНЬ косое и костыльное. Всё.